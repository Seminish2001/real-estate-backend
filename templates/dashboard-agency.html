
{% extends "base.html" %}

{% block title %}Agent Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Agent/Broker Dashboard</h1>
    <div id="loadingIndicator" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">Loading dashboard data...</p>
    </div>
    
    <div id="dashboardContent" class="row d-none">
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-success">Your Agent Profile</h5>
                    <div id="profileSummary">
                        <p><strong>Name:</strong> <span id="agentName"></span></p>
                        <p><strong>Agency:</strong> <span id="agentAgency"></span></p>
                        <p><strong>Tier:</strong> <span id="agentTier" class="badge bg-warning"></span></p>
                        <p><strong>Rating:</strong> <span id="agentRating"></span>/5.0</p>
                    </div>
                    
                    <h5 class="mt-4">Listing Metrics</h5>
                    <p><strong>Total Listings:</strong> <span id="totalListings"></span></p>
                    <p><strong>Active Listings:</strong> <span id="activeIndex"></span></p>
                    
                    <a href="/private-agent.html" class="btn btn-sm btn-outline-primary mt-2">Edit Profile</a>
                    <a href="/properties.html?action=new" class="btn btn-sm btn-success mt-2">Add New Listing</a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-danger">Live Chat Sessions</h5>
                    <p class="card-text text-muted">Manage all active conversations with buyers/renters.</p>
                    
                    <div id="sessionList" class="list-group mb-3" style="max-height: 350px; overflow-y: auto;">
                        <p class="text-center text-muted p-3" id="noSessions">You have no active chat sessions.</p>
                    </div>

                    <div id="activeChatWindow" class="card d-none">
                        <div class="card-header bg-light">
                            Chat with <strong id="chatUserName"></strong> (Property: <span id="chatPropertyId"></span>)
                        </div>
                        <div id="chatMessages" class="card-body" style="height: 300px; overflow-y: scroll;">
                            </div>
                        <div class="card-footer d-flex">
                            <input type="text" id="chatInput" class="form-control me-2" placeholder="Type your message..." disabled>
                            <button id="sendMessageBtn" class="btn btn-primary" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentSessionId = null;
    let currentAgentUserId = null;
    let socket = null;

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Fetch Agent Profile and Metrics
        fetchAgentProfile();
        // 2. Fetch Chat Sessions
        fetchChatSessions();
        
        // 3. Setup message sending handler
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                // Optional: Emit typing event
                // socket.emit('typing', { session_id: currentSessionId, sender_id: currentAgentUserId });
            }
        });
    });

    function showDashboard() {
        document.getElementById('loadingIndicator').classList.add('d-none');
        document.getElementById('dashboardContent').classList.remove('d-none');
    }

    // --- Profile and Metrics Logic ---

    async function fetchAgentProfile() {
        try {
            const response = await fetch('/api/agents/me');
            
            if (response.status === 403) {
                alert('Access Denied. You must be logged in as an Agent/Broker.');
                window.location.href = '/signin.html';
                return;
            }
            if (response.status === 404) {
                 // Agent needs to complete setup
                 alert('Profile incomplete. Redirecting to setup...');
                 window.location.href = '/private-agent.html'; // Assume this is your setup page
                 return;
            }
            if (!response.ok) throw new Error('Failed to load profile.');

            const data = await response.json();
            const profile = data.profile;

            // Store the agent's User ID (essential for sending messages)
            currentAgentUserId = profile.user_id;

            document.getElementById('agentName').textContent = profile.name;
            document.getElementById('agentAgency').textContent = profile.agency || 'Independent Agent';
            document.getElementById('agentTier').textContent = profile.tier.toUpperCase();
            document.getElementById('agentRating').textContent = profile.rating.toFixed(1);
            document.getElementById('totalListings').textContent = profile.listings_total;
            document.getElementById('activeIndex').textContent = profile.listings_active;

        } catch (error) {
            console.error('Profile load error:', error);
            document.getElementById('profileSummary').innerHTML = `<p class="text-danger">Error loading profile: ${error.message}</p>`;
        } finally {
            showDashboard();
        }
    }

    // --- Chat Session Logic ---

    async function fetchChatSessions() {
        const sessionList = document.getElementById('sessionList');
        sessionList.innerHTML = '';
        document.getElementById('noSessions').classList.add('d-none');

        try {
            const response = await fetch('/api/chat/sessions');
            if (response.status === 401) return; // Not logged in
            if (!response.ok) throw new Error('Failed to load sessions.');

            const sessions = await response.json();

            if (sessions.length === 0) {
                document.getElementById('noSessions').classList.remove('d-none');
                return;
            }

            sessions.forEach(session => {
                const sessionItem = document.createElement('a');
                sessionItem.href = "#";
                sessionItem.classList.add('list-group-item', 'list-group-item-action');
                sessionItem.setAttribute('data-session-id', session.session_id);
                sessionItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${session.other_party.name} <span class="badge bg-secondary">${session.other_party.role}</span></h6>
                        <small>${new Date(session.last_message_at).toLocaleTimeString()}</small>
                    </div>
                    <p class="mb-1 small">${session.last_message ? session.last_message.substring(0, 50) + '...' : 'No messages yet.'}</p>
                    <small class="text-info">Property: ${session.property_id || 'General Inquiry'}</small>
                `;
                sessionItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadChatHistory(session.session_id, session.other_party.name, session.property_id);
                });
                sessionList.appendChild(sessionItem);
            });

        } catch (error) {
            console.error('Session load error:', error);
            sessionList.innerHTML = `<p class="text-danger p-3">Error loading chat sessions.</p>`;
        }
    }

    async function loadChatHistory(sessionId, userName, propertyId) {
        currentSessionId = sessionId;
        document.getElementById('chatUserName').textContent = userName;
        document.getElementById('chatPropertyId').textContent = propertyId || 'N/A';
        document.getElementById('chatMessages').innerHTML = '<p class="text-center text-muted">Loading messages...</p>';
        document.getElementById('activeChatWindow').classList.remove('d-none');
        
        try {
            const response = await fetch(`/api/chat/messages/${sessionId}`);
            if (!response.ok) throw new Error('Failed to load messages.');

            const data = await response.json();
            document.getElementById('chatMessages').innerHTML = ''; // Clear loading message

            data.messages.forEach(msg => displayMessage(msg, userName));
            
            // Connect to SocketIO for real-time updates
            initSocketIO(sessionId);
            
            // Re-enable input fields after history load and socket connection
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight; // Scroll to bottom

        } catch (error) {
            console.error('History load error:', error);
            document.getElementById('chatMessages').innerHTML = `<p class="text-danger p-3">Error loading message history.</p>`;
        }
    }
    
    function displayMessage(msg, userName) {
        const isSelf = msg.sender_id == currentAgentUserId;
        const sender = isSelf ? 'You' : userName;
        const alignment = isSelf ? 'text-end' : 'text-start';
        const color = isSelf ? '#dcf8c6' : '#ffffff'; // Light green for self, white for other

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('mb-1', alignment);
        messageDiv.innerHTML = `
            <div style="background-color: ${color}; padding: 8px; border-radius: 10px; display: inline-block; max-width: 70%;">
                <small class="text-muted">${sender}</small><br>
                ${msg.content}
                <div class="small text-end text-muted" style="margin-top: 3px;">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        `;
        document.getElementById('chatMessages').appendChild(messageDiv);
    }
    
    // --- SocketIO and Sending Message Logic ---
    
    function initSocketIO(sessionId) {
        // Only connect if not already connected or if switching rooms
        if (socket && socket.connected && socket.sessionId === sessionId) return;

        // If switching rooms or re-connecting, close old socket
        if (socket && socket.connected) {
             socket.close();
        }
        
        socket = io(); 
        socket.sessionId = sessionId; // Store the session ID on the socket object
        
        socket.on('connect', () => {
            console.log('Socket connected. Joining room:', sessionId);
            socket.emit('join_chat', { session_id: sessionId, user_id: currentAgentUserId });
        });

        socket.on('new_message', (msg) => {
            // Only process messages for the currently viewed session
            if (msg.session_id == currentSessionId) {
                const userName = document.getElementById('chatUserName').textContent;
                displayMessage(msg, userName);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
            // Optional: Refresh session list to update last message time
            fetchChatSessions(); 
        });

        socket.on('disconnect', () => {
            console.log('Socket disconnected.');
        });
    }

    function sendMessage() {
        if (!socket || !socket.connected) {
            alert('Chat connection not established. Please reload.');
            return;
        }
        
        const input = document.getElementById('chatInput');
        const content = input.value.trim();

        if (content) {
            socket.emit('send_message', { 
                session_id: currentSessionId, 
                sender_id: currentAgentUserId, 
                content: content 
            });
            input.value = '';
        }
    }

</script>
{% endblock %}
