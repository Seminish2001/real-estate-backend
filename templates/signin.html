{% extends "base.html" %}

{% block title %}Sign In{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <h2 class="mb-4 text-center">Sign In to Your Account</h2>
        
        <div id="alertMessage" class="alert alert-danger d-none" role="alert"></div>

        <form id="signinForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
        </form>
        
        <div class="text-center mt-3">
            <a href="/signup.html">Don't have an account? Sign Up</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('signinForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const alertElement = document.getElementById('alertMessage');
    alertElement.classList.add('d-none');
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch('/signin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // X-CSRF-TOKEN is automatically handled by the base.html fetch override
            },
            body: JSON.stringify({ email, password })
        });

        // The backend sets the JWT cookies on a successful 200 response.
        if (response.ok) {
            const data = await response.json();
            alertElement.classList.remove('alert-danger');
            alertElement.classList.add('alert-success');
            alertElement.textContent = `Welcome ${data.user.name}! Redirecting to dashboard...`;
            alertElement.classList.remove('d-none');
            
            // Redirect based on the user's role (NEW LOGIC)
            setTimeout(() => {
                const role = data.user.role;
                if (role === 'ADMIN') {
                    window.location.href = '/dashboard-admin.html';
                } else if (role === 'AGENT' || role === 'BROKER') {
                    window.location.href = '/dashboard-agency.html';
                } else {
                    window.location.href = '/dashboard-buyer-renter.html';
                }
            }, 1500);

        } else {
            const errorData = await response.json();
            alertElement.textContent = errorData.message || 'Invalid credentials or server error.';
            alertElement.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Sign-in failed:', error);
        alertElement.textContent = 'Network error. Please try again.';
        alertElement.classList.remove('d-none');
    }
});
</script>
{% endblock %}

