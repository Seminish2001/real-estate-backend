<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Browse properties for sale and rent in Albania with advanced filters and map view." />
  <meta name="keywords" content="real estate, Albania, properties, homes, buy, rent, listings" />
  <meta name="author" content="Albania Properties" />
  <title>Properties | Albania Properties</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <!-- AOS Animation Library -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <!-- Google Maps -->
  <!-- Custom CSS -->
  <style>
    :root {
      --primary-color: #1a73e8;
      --primary-dark: #1557b0;
      --secondary-color: #2d3748;
      --accent-color: #00c4b4;
      --accent-dark: #00a89d;
      --background-light: #f9fafb;
      --background-dark: #1f2a44;
      --text-dark: #1f2a44;
      --text-light: #fff;
      --text-muted: #718096;
      --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 6px 25px rgba(0, 0, 0, 0.12);
      --border-radius: 12px;
      --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--background-light);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
    }

    a {
      text-decoration: none;
      color: inherit;
      transition: var(--transition);
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      padding: 20px 0;
      box-shadow: var(--shadow-sm);
      transition: padding 0.3s ease, background 0.3s ease;
    }

    header.scrolled {
      padding: 10px 0;
      background: rgba(255, 255, 255, 1);
    }

    .navbar-brand {
      font-size: 1.8rem;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      font-weight: 600;
    }

    .navbar-brand i {
      margin-right: 12px;
      color: var(--primary-color);
      font-size: 1.4rem;
    }

    .navbar-nav .nav-link {
      color: var(--text-dark);
      font-size: 1.1rem;
      font-weight: 400;
      margin-left: 30px;
      position: relative;
      padding-bottom: 6px;
      cursor: pointer;
    }

    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link.active {
      color: var(--primary-color);
    }

    .navbar-nav .nav-link::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      background: var(--primary-color);
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: width 0.3s ease;
    }

    .navbar-nav .nav-link:hover::after,
    .navbar-nav .nav-link.active::after {
      width: 80%;
    }

    /* Remove default arrow from language dropdown */
    #languageDropdown::after {
      display: none !important;
    }

    /* Properties Page Content */
    .properties-page {
      padding: 120px 0 80px;
    }

    .search-summary {
      font-size: 1.5rem;
      color: var(--text-dark);
      margin-bottom: 30px;
      font-weight: 600;
    }

    .search-summary span {
      color: var(--primary-color);
    }

    .filters-sidebar {
      position: sticky;
      top: 120px;
      background: #fff;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      height: fit-content;
    }

    .filters-sidebar h3 {
      font-size: 1.6rem;
      margin-bottom: 20px;
    }

    .filter-group {
      margin-bottom: 25px;
    }

    .filter-group label {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .filter-group input::placeholder {
      color: #a0aec0;
    }

    .btn-apply {
      background: var(--primary-color);
      color: var(--text-light);
      padding: 12px 0;
      width: 100%;
      border-radius: 8px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn-apply:hover {
      background: var(--primary-dark);
      transform: scale(1.02);
    }

    .listings-area {
      padding-left: 20px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
    }

    .toolbar select {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #f1f5f9;
      font-size: 1rem;
    }

    .toolbar .toggle-view button {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #718096;
      padding: 5px 15px;
      transition: var(--transition);
    }

    .toolbar .toggle-view button.active,
    .toolbar .toggle-view button:hover {
      color: var(--primary-color);
    }

    .property-card {
      border: none;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: #fff;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      position: relative;
      margin-bottom: 30px;
    }

    .property-card:hover {
      transform: translateY(-10px);
      box-shadow: var(--shadow-md);
    }

    .property-card img {
      height: 220px;
      width: 100%;
      object-fit: cover;
      transition: transform 0.6s ease;
    }

    .property-card:hover img {
      transform: scale(1.08);
    }

    .property-card .card-body {
      padding: 20px;
    }

    .property-card .badge {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 0.9rem;
      padding: 8px 15px;
      border-radius: 20px;
    }

    .property-card h5 {
      font-size: 1.5rem;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .property-card .price {
      font-size: 1.3rem;
      color: var(--primary-color);
      font-weight: 600;
    }

    .property-card .details {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .property-card .btn {
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      color: var(--text-light);
      font-weight: 600;
      transition: var(--transition);
    }

    .property-card .btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .property-favorite {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.3rem;
      color: #e2e8f0;
      cursor: pointer;
      transition: var(--transition);
      z-index: 1;
      background: rgba(255, 255, 255, 0.8);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .property-favorite:hover,
    .property-favorite.active {
      color: #ff4757;
    }

    #map-view {
      height: 600px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      display: none;
    }

    #map-view.active {
      display: block;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }

    .pagination a {
      padding: 10px 20px;
      margin: 0 5px;
      border-radius: 8px;
      background: #fff;
      color: var(--text-dark);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .pagination a.active,
    .pagination a:hover {
      background: var(--primary-color);
      color: var(--text-light);
    }

    /* Typeahead Suggestion Styles */
    .tt-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 1px solid #e2e8f0;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 5px;
    }

    .tt-suggestion {
      padding: 10px 15px;
      font-size: 1rem;
      color: var(--text-dark);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .tt-suggestion:hover,
    .tt-suggestion.tt-cursor {
      background: #f1f5f9;
    }

    .tt-highlight {
      color: var(--primary-color);
      font-weight: 600;
    }

    .tt-empty {
      padding: 10px 15px;
      font-size: 1rem;
      color: #718096;
    }

    /* Accessibility focus styles */
    a:focus, button:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Skip to content link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary-color);
      color: white;
      padding: 8px;
      z-index: 100;
      transition: top 0.3s;
    }

    .skip-link:focus {
      top: 0;
    }

    /* CORRECTED FOOTER STYLES (from homepage) */
    .footer {
      background: var(--background-dark);
      color: var(--text-light);
      padding: 5rem 0 2rem;
    }

    .footer-logo {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: inline-block;
    }

    .footer-logo i {
      color: var(--primary-color);
      margin-right: 10px;
    }

    .footer-about {
      margin-bottom: 2rem;
    }

    .footer-about-text {
      color: #a0aec0;
      margin-bottom: 1.5rem;
    }

    .footer-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: white;
    }

    .footer-links {
      list-style: none;
      padding: 0;
    }

    .footer-links li {
      margin-bottom: 0.75rem;
    }

    .footer-links a {
      color: #a0aec0;
      transition: var(--transition);
    }

    .footer-links a:hover {
      color: var(--primary-color);
      padding-left: 5px;
    }

    .footer-contact-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1rem;
      color: #a0aec0;
    }

    .footer-contact-icon {
      color: var(--primary-color);
      margin-right: 1rem;
      margin-top: 3px;
    }

    .social-icons {
      display: flex;
      margin-top: 1.5rem;
    }

    .social-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      color: white;
      transition: var(--transition);
    }

    .social-icon:hover {
      background: var(--primary-color);
      transform: translateY(-3px);
    }

    .footer-bottom {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 2rem;
      margin-top: 3rem;
      text-align: center;
      color: #a0aec0;
      font-size: 0.9rem;
    }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    [data-aos="fade-up"] {
      animation: fadeInUp 0.8s ease-out forwards;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .listings-area {
        padding-left: 0;
      }
      .filters-sidebar {
        position: static;
        margin-bottom: 30px;
      }
    }

    @media (max-width: 768px) {
      .navbar-nav .nav-link {
        margin-left: 0;
        padding: 10px 0;
      }
      .toolbar {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      .toolbar .toggle-view {
        align-self: flex-end;
      }
      .properties-page {
        padding: 100px 0 40px;
      }
    }

    @media (max-width: 576px) {
      .search-summary {
        font-size: 1.2rem;
      }
      .property-card h5 {
        font-size: 1.3rem;
      }
      .property-card .price {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Skip to content link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Header -->
  <header>
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="/" aria-label="Albania Properties Home">
          <i class="fas fa-home" aria-hidden="true"></i> Albania Properties
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="/properties?purpose=buy">Buy</a></li>
            <li class="nav-item"><a class="nav-link" href="/properties?purpose=rent">Rent</a></li>
            <li class="nav-item"><a class="nav-link" href="/sell">Sell</a></li>
            <li class="nav-item"><a class="nav-link" href="/agents">Find an Agent</a></li>
            <li class="nav-item" id="auth-link">
              <a class="nav-link" href="/signin" aria-label="Sign In">
                <i class="fas fa-user" aria-hidden="true"></i> Sign In
              </a>
            </li>
            <!-- Language dropdown with a globe icon -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Language selector">
                <i class="fas fa-globe" aria-hidden="true"></i>
                <span class="visually-hidden">Language</span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                <li><a class="dropdown-item" href="/?lang=al" lang="sq">🇦🇱 Albanian</a></li>
                <li><a class="dropdown-item" href="/?lang=en" lang="en">🇬🇧 English</a></li>
                <li><a class="dropdown-item" href="/?lang=it" lang="it">🇮🇹 Italian</a></li>
                <li><a class="dropdown-item" href="/?lang=de" lang="de">🇩🇪 German</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Properties Page Content -->
  <section class="properties-page" id="main-content">
    <div class="container">
      <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3">
          <div class="filters-sidebar" data-aos="fade-up">
            <h3>Refine Your Search</h3>
            <div class="filter-group">
              <label for="location-filter">Location</label>
              <input type="text" id="location-filter" name="location" placeholder="Enter city or region" aria-label="Enter location" />
            </div>
            <div class="filter-group">
              <label for="purpose-filter">Purpose</label>
              <select name="purpose" id="purpose-filter" aria-label="Select purpose">
                <option value="">All</option>
                <option value="buy">Buy</option>
                <option value="rent">Rent</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="property-type-filter">Property Type</label>
              <select name="type" id="property-type-filter" aria-label="Select property type">
                <option value="">All Types</option>
                <option value="apartment">Apartment</option>
                <option value="house">House</option>
                <option value="villa">Villa</option>
                <option value="land">Land</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="max-price">Max Price (€)</label>
              <input type="number" id="max-price" name="max-price" placeholder="Enter max price" min="0" step="1000" aria-label="Enter maximum price" />
            </div>
            <div class="filter-group">
              <label for="bedrooms-filter">Bedrooms</label>
              <select name="beds" id="bedrooms-filter" aria-label="Select number of bedrooms">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="2">2+</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="bathrooms-filter">Bathrooms</label>
              <select name="baths" id="bathrooms-filter" aria-label="Select number of bathrooms">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="2">2+</option>
                <option value="3">3+</option>
              </select>
            </div>
            <button class="btn-apply">Apply Filters</button>
          </div>
        </div>

        <!-- Listings Area -->
        <div class="col-md-9 listings-area">
          <div class="search-summary" data-aos="fade-up">
            Showing <span id="property-count">0</span> properties in <span id="search-location">All</span>
          </div>

          <div class="toolbar" data-aos="fade-up" data-aos-delay="200">
            <select name="sort" id="sort-filter" aria-label="Sort properties">
              <option>Sort by: Relevance</option>
              <option>Price: Low to High</option>
              <option>Price: High to Low</option>
              <option>Newest</option>
            </select>
            <div class="toggle-view">
              <button id="grid-view-btn" class="active" aria-label="Grid view">
                <i class="fas fa-th"></i>
              </button>
              <button id="map-view-btn" aria-label="Map view">
                <i class="fas fa-map"></i>
              </button>
            </div>
          </div>

          <!-- Grid View -->
          <div id="grid-view" class="row g-4 active" data-aos="fade-up" data-aos-delay="300">
            <!-- Properties will be dynamically inserted here -->
            <div class="col-md-4">
              <div class="property-card">
                <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Modern penthouse in Tirana with city views" loading="lazy" />
                <div class="card-body">
                  <span class="badge bg-success">New Listing</span>
                  <h5>Tirana Skyline Penthouse</h5>
                  <p class="price">€450,000</p>
                  <p class="details">3 Beds • 2 Baths • 1500 sqft • Central Tirana</p>
                  <a href="/property/tirana-penthouse" class="btn">View Details</a>
                  <button class="property-favorite" aria-label="Add to favorites">
                    <i class="fas fa-heart"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="property-card">
                <img src="https://images.unsplash.com/photo-1560185893-a55cbc8c57e8?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Luxury villa in Vlora with sea views" loading="lazy" />
                <div class="card-body">
                  <h5>Vlora Coastal Villa</h5>
                  <p class="price">€780,000</p>
                  <p class="details">4 Beds • 3 Baths • 2200 sqft • Vlora Beach</p>
                  <a href="/property/vlora-villa" class="btn">View Details</a>
                  <button class="property-favorite" aria-label="Add to favorites">
                    <i class="fas fa-heart"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="property-card">
                <img src="https://images.unsplash.com/photo-1600585154526-990dced4363d?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Seafront apartment in Saranda with balcony" loading="lazy" />
                <div class="card-body">
                  <span class="badge bg-info">Open House</span>
                  <h5>Saranda Seafront Apartment</h5>
                  <p class="price">€220,000</p>
                  <p class="details">2 Beds • 1 Bath • 900 sqft • Saranda Center</p>
                  <a href="/property/saranda-apartment" class="btn">View Details</a>
                  <button class="property-favorite" aria-label="Add to favorites">
                    <i class="fas fa-heart"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Map View -->
          <div id="map-view"></div>

          <!-- Pagination -->
          <div class="pagination" data-aos="fade-up" data-aos-delay="400">
            <a href="#" aria-label="Previous page">Previous</a>
            <a href="#" aria-label="Page 1">1</a>
            <a href="#" class="active" aria-label="Current page 2">2</a>
            <a href="#" aria-label="Page 3">3</a>
            <a href="#" aria-label="Next page">Next</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer - Corrected Version -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-3 col-md-6">
          <a href="/" class="footer-logo"><i class="fas fa-home"></i>Albania Properties</a>
          <p class="footer-about-text">Connecting buyers, sellers, and renters with Albania's finest properties since 2015. Our mission is to make real estate transactions seamless and transparent.</p>
          <div class="social-icons">
            <a href="#" class="social-icon" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-icon" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-icon" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
            <a href="#" class="social-icon" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <h3 class="footer-title">Quick Links</h3>
          <ul class="footer-links">
            <li><a href="/properties">Browse Properties</a></li>
            <li><a href="/sell">Sell Your Property</a></li>
            <li><a href="/agents">Find an Agent</a></li>
            <li><a href="/mortgage">Mortgage Calculator</a></li>
            <li><a href="/market-trends">Market Trends</a></li>
            <li><a href="/blog">Real Estate Blog</a></li>
          </ul>
        </div>
        <div class="col-lg-3 col-md-6">
          <h3 class="footer-title">Cities</h3>
          <ul class="footer-links">
            <li><a href="/properties?location=Tirana">Tirana</a></li>
            <li><a href="/properties?location=Durres">Durres</a></li>
            <li><a href="/properties?location=Vlora">Vlora</a></li>
            <li><a href="/properties?location=Saranda">Saranda</a></li>
            <li><a href="/properties?location=Shkodra">Shkodra</a></li>
            <li><a href="/properties?location=Berat">Berat</a></li>
          </ul>
        </div>
        <div class="col-lg-3 col-md-6">
          <h3 class="footer-title">Contact Us</h3>
          <div class="footer-contact-item">
            <i class="fas fa-map-marker-alt footer-contact-icon"></i>
            <div>Rr. Deshmoret e 4 Shkurtit, Tirana 1001, Albania</div>
          </div>
          <div class="footer-contact-item">
            <i class="fas fa-phone-alt footer-contact-icon"></i>
            <div>+355 4 123 4567</div>
          </div>
          <div class="footer-contact-item">
            <i class="fas fa-envelope footer-contact-icon"></i>
            <div>info@albaniaproperties.com</div>
          </div>
          <div class="footer-contact-item">
            <i class="fas fa-clock footer-contact-icon"></i>
            <div>Mon-Fri: 9AM-6PM<br>Sat: 10AM-4PM</div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Albania Properties. All Rights Reserved. | <a href="/privacy">Privacy Policy</a> | <a href="/terms">Terms of Service</a></p>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize AOS animations
      AOS.init({ 
        duration: 1000, 
        once: true,
        offset: 120
      });

      // Sticky header
      window.addEventListener('scroll', () => {
        const header = document.querySelector('header');
        header.classList.toggle('scrolled', window.scrollY > 50);
      });

      // Check if user is logged in and update header
      async function checkLoginStatus() {
        try {
          const response = await fetch('/api/auth/status', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await response.json();
          if (response.ok && data.authenticated) {
            const user = data.user;
            const authLink = document.getElementById('auth-link');
            authLink.innerHTML = `
              <a class="nav-link" href="/dashboard/${user.user_type.replace('/', '-').toLowerCase()}" aria-label="User dashboard">
                <i class="fas fa-user" aria-hidden="true"></i> ${user.name}
              </a>
            `;
          }
        } catch (error) {
          console.error('Error checking login status:', error);
        }
      }

      // Run on page load
      checkLoginStatus();

      // Toggle between grid and map view
      const gridView = document.getElementById('grid-view');
      const mapView = document.getElementById('map-view');
      const gridBtn = document.getElementById('grid-view-btn');
      const mapBtn = document.getElementById('map-view-btn');
      let map, markers;

      gridBtn.addEventListener('click', () => {
        gridView.classList.add('active');
        mapView.classList.remove('active');
        gridBtn.classList.add('active');
        mapBtn.classList.remove('active');
      });

      mapBtn.addEventListener('click', () => {
        gridView.classList.remove('active');
        mapView.classList.add('active');
        gridBtn.classList.remove('active');
        mapBtn.classList.add('active');
        initMap();
      });

      // Favorite toggle
      document.querySelectorAll('.property-favorite').forEach(heart => {
        heart.addEventListener('click', () => {
          heart.classList.toggle('active');
        });
      });

      // Initialize Google Map
      let mapInitialized = false;
      let markers = [];
      let markerCluster;
      function initMap(properties = []) {
        if (!mapInitialized) {
          map = new google.maps.Map(document.getElementById('map-view'), {
            center: { lat: 41.3275, lng: 19.8187 },
            zoom: 10,
            styles: [
              {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
              }
            ]
          });
          mapInitialized = true;
        }
        if (markerCluster) {
          markerCluster.clearMarkers();
        }
        markers.forEach(m => m.setMap(null));
        markers = [];
        
        // Sample properties data
        const defaultProperties = [
          {
            id: 'tirana-penthouse',
            title: 'Tirana Skyline Penthouse',
            price: '450,000',
            type: 'apartment',
            lat: 41.3275,
            lng: 19.8187,
            beds: 3,
            baths: 2,
            area: '1500 sqft',
            location: 'Central Tirana'
          },
          {
            id: 'vlora-villa',
            title: 'Vlora Coastal Villa',
            price: '780,000',
            type: 'villa',
            lat: 40.4664,
            lng: 19.4914,
            beds: 4,
            baths: 3,
            area: '2200 sqft',
            location: 'Vlora Beach'
          },
          {
            id: 'saranda-apartment',
            title: 'Saranda Seafront Apartment',
            price: '220,000',
            type: 'apartment',
            lat: 39.8760,
            lng: 20.0050,
            beds: 2,
            baths: 1,
            area: '900 sqft',
            location: 'Saranda Center'
          }
        ];
        
        properties = properties.length ? properties : defaultProperties;
        
        properties.forEach(prop => {
          if (prop.lat && prop.lng) {
            const marker = new google.maps.Marker({
              position: { lat: prop.lat, lng: prop.lng },
              title: prop.title,
              map: map
            });
            const info = new google.maps.InfoWindow({
              content: `
                <div class="map-popup">
                  <h5>${prop.title}</h5>
                  <p class="price">€${prop.price}</p>
                  <p>${prop.beds} Beds • ${prop.baths} Baths • ${prop.area}</p>
                  <p><small>${prop.location}</small></p>
                  <a href="/property/${prop.id}" class="btn btn-sm btn-primary w-100">View Details</a>
                </div>`
            });
            marker.addListener('click', () => info.open({ map, anchor: marker }));
            markers.push(marker);
          }
        });
        markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
      }

      // Autocomplete for location filter
      const locations = [
        "Berat", "Kučové", "Poliçan", "Ura Vajgurore", "Peshkopi", "Bulqizë", "Klos", "Burrel",
        "Durrës", "Krujë", "Shijak", "Manëz", "Elbasan", "Cërrik", "Librazhd", "Peqin",
        "Gramsh", "Belsh", "Fier", "Lushnjë", "Patos", "Ballsh", "Roskovec", "Gjirokastër",
        "Tepelenë", "Memaliaj", "Përmet", "Korçë", "Pogradec", "Maliq", "Bilisht", "Kukës",
        "Krumë", "Bajram Curri", "Lezhë", "Lač", "Rreshen", "Mamurras", "Shkodër", "Pukë",
        "Fushë-Arrëz", "Vau i Dejës", "Koplik", "Tirana", "Kamëz", "Vora", "Kavajë",
        "Rrogozhinë", "Vlorë", "Sarandë", "Himarë", "Delvinë", "Konispol", "Orikum", "Selenicë"
      ];
      const substringMatcher = (strs) => {
        return (q, cb) => {
          const matches = strs.filter(str => new RegExp(q, 'i').test(str));
          cb(matches);
        };
      };
      $('#location-filter').typeahead({
        hint: false,
        highlight: true,
        minLength: 1
      }, {
        name: 'locations',
        source: substringMatcher(locations),
        limit: 10
      });

      // Apply filters
      document.querySelector('.btn-apply').addEventListener('click', () => {
        const location = document.getElementById('location-filter').value;
        const purpose = document.getElementById('purpose-filter').value;
        const type = document.getElementById('property-type-filter').value;
        const maxPrice = document.getElementById('max-price').value;
        const beds = document.getElementById('bedrooms-filter').value;
        const baths = document.getElementById('bathrooms-filter').value;
        const query = `/properties?location=${encodeURIComponent(location)}&purpose=${encodeURIComponent(purpose)}&type=${encodeURIComponent(type)}&maxPrice=${encodeURIComponent(maxPrice)}&beds=${encodeURIComponent(beds)}&baths=${encodeURIComponent(baths)}`;
        window.history.pushState({}, document.title, query);
        fetchProperties();
      });

      // Sort filter change
      document.getElementById('sort-filter').addEventListener('change', fetchProperties);

      // Pre-select Purpose from URL
      const urlParams = new URLSearchParams(window.location.search);
      const purpose = urlParams.get('purpose');
      if (purpose === 'buy') {
        document.querySelector('a[href="/properties?purpose=buy"]').classList.add('active');
        document.querySelector('a[href="/properties?purpose=rent"]').classList.remove('active');
      } else if (purpose === 'rent') {
        document.querySelector('a[href="/properties?purpose=rent"]').classList.add('active');
        document.querySelector('a[href="/properties?purpose=buy"]').classList.remove('active');
      }
      
      // Initialize the map
      initMap();
    });
  </script>
</body>
</html>
