{% extends "base.html" %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Welcome Back, <span id="userNamePlaceholder">User!</span></h1>
    <div id="loadingIndicator" class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">Loading user data...</p>
    </div>
    
    <div id="dashboardContent" class="row d-none">
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-success">Account Summary</h5>
                    <div id="profileSummary">
                        <p><strong>Name:</strong> <span id="profileName"></span></p>
                        <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                        <p><strong>Role:</strong> <span id="profileRole" class="badge bg-primary"></span></p>
                    </div>
                    
                    <h5 class="mt-4">Quick Actions</h5>
                    <a href="/evaluation.html" class="btn btn-sm btn-info w-100 mb-2">
                        Request Property Evaluation
                    </a>
                    <a href="/settings.html" class="btn btn-sm btn-outline-secondary w-100 mb-2">
                        Account Settings
                    </a>
                    <button id="logoutBtn" class="btn btn-sm btn-danger w-100">
                        Log Out
                    </button>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">My Valuation Requests</h5>
                    <div id="evaluationRequestsList">
                        <p class="text-muted small">No recent requests found.</p>
                        </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-warning">My Saved Properties (Favorites)</h5>
                    <div id="favoritePropertiesList" class="row row-cols-1 row-cols-md-2 g-3">
                        <p class="text-center text-muted p-4 w-100" id="noFavorites">You haven't saved any properties yet.</p>
                        </div>
                    <a href="/properties.html" class="btn btn-sm btn-outline-primary mt-3 w-100">Browse Listings</a>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-danger">Recent Agent Chats</h5>
                    <div id="recentChatsList" class="list-group" style="max-height: 250px; overflow-y: auto;">
                        <p class="text-muted small p-2" id="noRecentChats">Start a chat from any property detail page!</p>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchUserData();
        fetchFavorites();
        fetchRecentChats(); 
        
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    });

    function showDashboard() {
        document.getElementById('loadingIndicator').classList.add('d-none');
        document.getElementById('dashboardContent').classList.remove('d-none');
    }

    // --- User Profile & Logout Logic ---

    async function fetchUserData() {
        try {
            // Assuming a GET /api/auth/me or similar endpoint exists to get user details
            const response = await fetch('/api/auth/me'); 
            
            if (response.status === 401) {
                alert('Session expired. Please sign in again.');
                window.location.href = '/signin.html';
                return;
            }
            if (!response.ok) throw new Error('Failed to load user data.');

            const user = await response.json();
            
            document.getElementById('userNamePlaceholder').textContent = user.name;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileRole').textContent = user.role.toUpperCase();

        } catch (error) {
            console.error('User data load error:', error);
            document.getElementById('profileSummary').innerHTML = `<p class="text-danger">Error loading user profile.</p>`;
        } finally {
            showDashboard();
        }
    }
    
    async function handleLogout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': window.CSRF_TOKEN // Essential for JWT security
                }
            });
            
            if (response.ok) {
                // Clear the locally stored CSRF token (though cookies handle most of it)
                delete window.CSRF_TOKEN; 
                alert('You have been successfully logged out.');
                window.location.href = '/signin.html';
            } else {
                alert('Logout failed. Try clearing your cookies.');
            }
        } catch (error) {
            console.error('Logout failed:', error);
            alert('Network error during logout.');
        }
    }


    // --- Favorites Logic ---
    
    async function fetchFavorites() {
        const listElement = document.getElementById('favoritePropertiesList');
        listElement.innerHTML = '';
        document.getElementById('noFavorites').classList.add('d-none');

        try {
            // NOTE: This assumes you have a GET /api/properties/favorites route
            const response = await fetch('/api/properties/favorites'); 
            if (!response.ok) throw new Error('Failed to load favorites.');
            
            const properties = await response.json();
            
            if (properties.length === 0) {
                document.getElementById('noFavorites').classList.remove('d-none');
                return;
            }

            properties.forEach(p => {
                const card = createFavoriteCard(p);
                listElement.insertAdjacentHTML('beforeend', card);
            });

        } catch (error) {
            console.error('Favorites load error:', error);
            listElement.innerHTML = `<p class="text-danger p-4 w-100">Error loading saved properties.</p>`;
        }
    }
    
    function createFavoriteCard(property) {
        const priceDisplay = property.purpose === 'RENT' 
            ? `$${property.monthly_rent.toLocaleString()} / mo` 
            : `$${property.price.toLocaleString()}`;
            
        const imageUrl = property.image_url || '/static/images/placeholder.jpg';
        
        return `
            <div class="col">
                <div class="card h-100">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img src="${imageUrl}" class="img-fluid rounded-start h-100" style="object-fit: cover;" alt="${property.title}">
                        </div>
                        <div class="col-md-8">
                            <div class="card-body p-3">
                                <span class="badge bg-warning mb-1">${property.purpose}</span>
                                <h6 class="card-title">${property.title}</h6>
                                <p class="card-text small mb-1">${property.location}</p>
                                <p class="card-text fw-bold">${priceDisplay}</p>
                                <a href="/property_detail.html?id=${property.id}" class="btn btn-sm btn-primary">Details</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // --- Recent Chats Logic ---

    async function fetchRecentChats() {
        const listElement = document.getElementById('recentChatsList');
        listElement.innerHTML = '';
        document.getElementById('noRecentChats').classList.add('d-none');

        try {
            // Re-use the /api/chat/sessions endpoint
            const response = await fetch('/api/chat/sessions');
            if (!response.ok) throw new Error('Failed to load chat sessions.');

            const sessions = await response.json();

            if (sessions.length === 0) {
                document.getElementById('noRecentChats').classList.remove('d-none');
                return;
            }

            sessions.slice(0, 5).forEach(session => { // Display only the top 5
                const chatItem = document.createElement('a');
                chatItem.href = `javascript:void(0);`; // Link to open chat modal/window
                chatItem.classList.add('list-group-item', 'list-group-item-action', 'small');
                chatItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Agent: ${session.other_party.name}</h6>
                        <small>${new Date(session.last_message_at).toLocaleDateString()}</small>
                    </div>
                    <p class="mb-1 text-truncate">${session.last_message || 'Session started.'}</p>
                `;
                listElement.appendChild(chatItem);
            });

        } catch (error) {
            console.error('Chat load error:', error);
            listElement.innerHTML = `<p class="text-danger p-2">Error loading recent chats.</p>`;
        }
    }
</script>
{% endblock %}
