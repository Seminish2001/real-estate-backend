{% extends "base.html" %}

{% block title %}Find Your Dream Property{% endblock %}

{% block maps_scripts %}
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap">
    </script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3">
        <div class="card p-3 mb-4">
            <h5 class="card-title">Filter Properties</h5>
            <form id="propertySearchForm">
                
                <div class="mb-3">
                    <label for="searchLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="searchLocation" placeholder="City or Zip">
                </div>
                
                <div class="mb-3">
                    <label for="searchPurpose" class="form-label">Purpose</label>
                    <select class="form-select" id="searchPurpose">
                        <option value="">Any</option>
                        <option value="SALE">For Sale</option>
                        <option value="RENT">For Rent</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="searchMinPrice" class="form-label">Min Price</label>
                    <input type="number" class="form-control" id="searchMinPrice" min="0">
                </div>
                
                <div class="mb-3">
                    <label for="searchMaxPrice" class="form-label">Max Price</label>
                    <input type="number" class="form-control" id="searchMaxPrice">
                </div>

                <button type="submit" class="btn btn-primary w-100">Search</button>
            </form>
        </div>
    </div>
    
    <div class="col-lg-9">
        <h3 class="mb-4">Properties Matching Your Search</h3>
        <div id="loadingIndicator" class="text-center d-none">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="mt-2">Loading listings...</p>
        </div>
        <div id="propertyList" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
            </div>
        <p id="noResults" class="text-center mt-5 d-none">No properties found matching your criteria.</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('propertySearchForm');
        form.addEventListener('submit', handleSearchSubmit);
        
        // Initial load of properties when the page loads
        fetchProperties();
    });

    function handleSearchSubmit(event) {
        event.preventDefault();
        fetchProperties();
    }

    // Function to construct the property card HTML
    function createPropertyCard(property) {
        // Fallback for image and price based on the new model structure
        const priceDisplay = property.purpose === 'RENT' 
            ? `$${property.monthly_rent.toLocaleString()} / mo` 
            : `$${property.price.toLocaleString()}`;
        
        const imageUrl = property.image_url || '/static/images/placeholder.jpg';
        
        return `
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <img src="${imageUrl}" class="card-img-top" alt="${property.title}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <span class="badge bg-info text-dark mb-2">${property.purpose}</span>
                        <h5 class="card-title">${property.title}</h5>
                        <p class="card-text text-muted">${property.location}</p>
                        <p class="card-text fw-bold fs-5">${priceDisplay}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                ${property.beds} Bed | ${property.baths} Bath | ${property.size} sqft
                            </small>
                            <a href="/property_detail.html?id=${property.id}" class="btn btn-sm btn-outline-primary">View Details</a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function fetchProperties() {
        const listElement = document.getElementById('propertyList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noResults = document.getElementById('noResults');

        listElement.innerHTML = '';
        noResults.classList.add('d-none');
        loadingIndicator.classList.remove('d-none');
        
        // Build query parameters from the form
        const location = document.getElementById('searchLocation').value;
        const purpose = document.getElementById('searchPurpose').value;
        const minPrice = document.getElementById('searchMinPrice').value;
        const maxPrice = document.getElementById('searchMaxPrice').value;

        const params = new URLSearchParams();
        if (location) params.append('location', location);
        if (purpose) params.append('purpose', purpose);
        if (minPrice) params.append('min_price', minPrice);
        if (maxPrice) params.append('max_price', maxPrice);

        try {
            const response = await fetch(`/api/properties?${params.toString()}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const properties = await response.json();
            loadingIndicator.classList.add('d-none');

            if (properties && properties.length > 0) {
                properties.forEach(property => {
                    listElement.insertAdjacentHTML('beforeend', createPropertyCard(property));
                });
            } else {
                noResults.classList.remove('d-none');
            }

        } catch (error) {
            console.error('Failed to fetch properties:', error);
            loadingIndicator.classList.add('d-none');
            listElement.innerHTML = `<div class="alert alert-danger" role="alert">Error loading properties: ${error.message}</div>`;
        }
    }
    
    // Placeholder function for Google Maps initialization
    function initMap() {
        console.log("Google Maps initialized (if API key is present).");
        // Actual map integration logic (geocoding, marker placement) would go here.
    }
</script>
{% endblock %}

